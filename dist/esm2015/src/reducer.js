import { ALL_NGRX_FORMS_ACTION_TYPES } from './actions';
import { formArrayReducer } from './array/reducer';
import { formControlReducer } from './control/reducer';
import { formGroupReducer } from './group/reducer';
import { isArrayState, isFormState, isGroupState } from './state';
export function formStateReducer(state, action) {
    if (!state) {
        throw new Error('The form state must be defined!');
    }
    if (!isFormState(state)) {
        throw new Error(`state must be a form state, got ${state}`);
    }
    if (isGroupState(state)) {
        return formGroupReducer(state, action);
    }
    if (isArrayState(state)) {
        return formArrayReducer(state, action);
    }
    return formControlReducer(state, action);
}
/**
 * This function creates a reducer function that first applies an action to the state
 * and afterwards applies all given update functions one after another to the resulting
 * form state. However, the update functions are only applied if the form state changed
 * as result of applying the action. If you need the update functions to be applied
 * regardless of whether the state changed (e.g. because the update function closes
 * over variables that may change independently of the form state) you can simply apply
 * the update manually (e.g. `updateFunction(formStateReducer(state, action))`).
 *
 * The following (contrived) example uses this function to create a reducer that after
 * each action validates the child control `name` to be required and sets the child
 * control `email`'s value to be `''` if the name is invalid.
 *
```typescript
interface FormValue {
  name: string;
  email: string;
}

const updateFormState = updateGroup<FormValue>(
  {
    name: validate(required),
  },
  {
    email: (email, parentGroup) =>
      parentGroup.controls.name.isInvalid
        ? setValue('', email)
        : email,
  },
);

const reducer = createFormStateReducerWithUpdate<FormValue>(updateFormState);
```
 */
export function createFormStateReducerWithUpdate(updateFnOrUpdateFnArr, ...updateFnArr) {
    updateFnArr = [...(Array.isArray(updateFnOrUpdateFnArr) ? updateFnOrUpdateFnArr : [updateFnOrUpdateFnArr]), ...updateFnArr];
    return (state, action) => {
        const newState = formStateReducer(state, action);
        return newState === state ? state : updateFnArr.reduce((s, f) => f(s), newState);
    };
}
function reduceNestedFormState(state, key, action) {
    const value = state[key];
    if (!isFormState(value)) {
        return state;
    }
    return Object.assign({}, state, { [key]: formStateReducer(value, action) });
}
function reduceNestedFormStates(state, action) {
    return Object.keys(state).reduce((s, key) => reduceNestedFormState(s, key, action), state);
}
/**
 * This function returns an object that can be passed to ngrx's `createReducer`
 * function (available starting with ngrx version 8). By doing this all form
 * state properties on the state will be updated whenever necessary (i.e.
 * whenever an ngrx-forms action is dispatched).
 *
 * To manually update a form state (e.g. to validate it) use
 * `wrapReducerWithFormStateUpdate`.
 */
export function onNgrxForms() {
    return {
        reducer: (state, action) => reduceNestedFormStates(state, action),
        types: ALL_NGRX_FORMS_ACTION_TYPES,
    };
}
/**
 * Define a reducer for a ngrx-forms action. This functions works the same as
 * ngrx's `on` except that you provide the ngrx-forms action class instead of
 * your action creator as a parameter.
 */
export function onNgrxFormsAction(actionCons, reducer) {
    return {
        reducer: (state, action) => reducer(reduceNestedFormStates(state, action), action),
        types: [actionCons.TYPE],
    };
}
/**
 * This function wraps a reducer and returns another reducer that first calls
 * the given reducer and then calls the given update function for the form state
 * that is specified by the form state locator function.
 *
 * The update function is passed the form state and the updated containing state
 * as parameters.
 */
export function wrapReducerWithFormStateUpdate(reducer, formStateLocator, updateFn) {
    return (state, action) => {
        const updatedState = reducer(state, action);
        const formState = formStateLocator(updatedState);
        const formStateKey = Object.keys(updatedState).find(key => updatedState[key] === formState);
        const updatedFormState = updateFn(formState, updatedState);
        if (updatedFormState === formState) {
            return updatedState;
        }
        return Object.assign({}, updatedState, { [formStateKey]: updatedFormState });
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkdWNlci5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25ncngtZm9ybXMvIiwic291cmNlcyI6WyJzcmMvcmVkdWNlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQVcsMkJBQTJCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDakUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdkQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDbkQsT0FBTyxFQUFxRCxZQUFZLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUdySCxNQUFNLFVBQVUsZ0JBQWdCLENBQzlCLEtBQW1FLEVBQ25FLE1BQWM7SUFFZCxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQ1YsTUFBTSxJQUFJLEtBQUssQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0tBQ3BEO0lBRUQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN2QixNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0tBQzdEO0lBRUQsSUFBSSxZQUFZLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDdkIsT0FBTyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFRLENBQUM7S0FDL0M7SUFFRCxJQUFJLFlBQVksQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUN2QixPQUFPLGdCQUFnQixDQUFDLEtBQUssRUFBRSxNQUFNLENBQVEsQ0FBQztLQUMvQztJQUVELE9BQU8sa0JBQWtCLENBQUMsS0FBOEIsRUFBRSxNQUFNLENBQVEsQ0FBQztBQUMzRSxDQUFDO0FBRUQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWlDRztBQUNILE1BQU0sVUFBVSxnQ0FBZ0MsQ0FDOUMscUJBQW9GLEVBQ3BGLEdBQUcs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QUMsRUFBRSxnQkFBZ0IsSUFDaEM7SUFDSixDQUFDLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWN0aW9uLCBBY3Rpb25SZWR1Y2VyIH0gZnJvbSAnQG5ncngvc3RvcmUnO1xuXG5pbXBvcnQgeyBBY3Rpb25zLCBBTExfTkdSWF9GT1JNU19BQ1RJT05fVFlQRVMgfSBmcm9tICcuL2FjdGlvbnMnO1xuaW1wb3J0IHsgZm9ybUFycmF5UmVkdWNlciB9IGZyb20gJy4vYXJyYXkvcmVkdWNlcic7XG5pbXBvcnQgeyBmb3JtQ29udHJvbFJlZHVjZXIgfSBmcm9tICcuL2NvbnRyb2wvcmVkdWNlcic7XG5pbXBvcnQgeyBmb3JtR3JvdXBSZWR1Y2VyIH0gZnJvbSAnLi9ncm91cC9yZWR1Y2VyJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbFN0YXRlLCBGb3JtQ29udHJvbFN0YXRlLCBGb3JtU3RhdGUsIGlzQXJyYXlTdGF0ZSwgaXNGb3JtU3RhdGUsIGlzR3JvdXBTdGF0ZSB9IGZyb20gJy4vc3RhdGUnO1xuaW1wb3J0IHsgUHJvamVjdEZuIH0gZnJvbSAnLi91cGRhdGUtZnVuY3Rpb24vdXRpbCc7XG5cbmV4cG9ydCBmdW5jdGlvbiBmb3JtU3RhdGVSZWR1Y2VyPFRWYWx1ZT4oXG4gIHN0YXRlOiBGb3JtU3RhdGU8VFZhbHVlPiB8IEFic3RyYWN0Q29udHJvbFN0YXRlPFRWYWx1ZT4gfCB1bmRlZmluZWQsXG4gIGFjdGlvbjogQWN0aW9uLFxuKTogRm9ybVN0YXRlPFRWYWx1ZT4ge1xuICBpZiAoIXN0YXRlKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgZm9ybSBzdGF0ZSBtdXN0IGJlIGRlZmluZWQhJyk7XG4gIH1cblxuICBpZiAoIWlzRm9ybVN0YXRlKHN0YXRlKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgc3RhdGUgbXVzdCBiZSBhIGZvcm0gc3RhdGUsIGdvdCAke3N0YXRlfWApO1xuICB9XG5cbiAgaWYgKGlzR3JvdXBTdGF0ZShzdGF0ZSkpIHtcbiAgICByZXR1cm4gZm9ybUdyb3VwUmVkdWNlcihzdGF0ZSwgYWN0aW9uKSBhcyBhbnk7XG4gIH1cblxuICBpZiAoaXNBcnJheVN0YXRlKHN0YXRlKSkge1xuICAgIHJldHVybiBmb3JtQXJyYXlSZWR1Y2VyKHN0YXRlLCBhY3Rpb24pIGFzIGFueTtcbiAgfVxuXG4gIHJldHVybiBmb3JtQ29udHJvbFJlZHVjZXIoc3RhdGUgYXMgRm9ybUNvbnRyb2xTdGF0ZTxhbnk+LCBhY3Rpb24pIGFzIGFueTtcbn1cblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgYSByZWR1Y2VyIGZ1bmN0aW9uIHRoYXQgZmlyc3QgYXBwbGllcyBhbiBhY3Rpb24gdG8gdGhlIHN0YXRlXG4gKiBhbmQgYWZ0ZXJ3YXJkcyBhcHBsaWVzIGFsbCBnaXZlbiB1cGRhdGUgZnVuY3Rpb25zIG9uZSBhZnRlciBhbm90aGVyIHRvIHRoZSByZXN1bHRpbmdcbiAqIGZvcm0gc3RhdGUuIEhvd2V2ZXIsIHRoZSB1cGRhdGUgZnVuY3Rpb25zIGFyZSBvbmx5IGFwcGxpZWQgaWYgdGhlIGZvcm0gc3RhdGUgY2hhbmdlZFxuICogYXMgcmVzdWx0IG9mIGFwcGx5aW5nIHRoZSBhY3Rpb24uIElmIHlvdSBuZWVkIHRoZSB1cGRhdGUgZnVuY3Rpb25zIHRvIGJlIGFwcGxpZWRcbiAqIHJlZ2FyZGxlc3Mgb2Ygd2hldGhlciB0aGUgc3RhdGUgY2hhbmdlZCAoZS5nLiBiZWNhdXNlIHRoZSB1cGRhdGUgZnVuY3Rpb24gY2xvc2VzXG4gKiBvdmVyIHZhcmlhYmxlcyB0aGF0IG1heSBjaGFuZ2UgaW5kZXBlbmRlbnRseSBvZiB0aGUgZm9ybSBzdGF0ZSkgeW91IGNhbiBzaW1wbHkgYXBwbHlcbiAqIHRoZSB1cGRhdGUgbWFudWFsbHkgKGUuZy4gYHVwZGF0ZUZ1bmN0aW9uKGZvcm1TdGF0ZVJlZHVjZXIoc3RhdGUsIGFjdGlvbikpYCkuXG4gKlxuICogVGhlIGZvbGxvd2luZyAoY29udHJpdmVkKSBleGFtcGxlIHVzZXMgdGhpcyBmdW5jdGlvbiB0byBjcmVhdGUgYSByZWR1Y2VyIHRoYXQgYWZ0ZXJcbiAqIGVhY2ggYWN0aW9uIHZhbGlkYXRlcyB0aGUgY2hpbGQgY29udHJvbCBgbmFtZWAgdG8gYmUgcmVxdWlyZWQgYW5kIHNldHMgdGhlIGNoaWxkXG4gKiBjb250cm9sIGBlbWFpbGAncyB2YWx1ZSB0byBiZSBgJydgIGlmIHRoZSBuYW1lIGlzIGludmFsaWQuXG4gKlxuYGBgdHlwZXNjcmlwdFxuaW50ZXJmYWNlIEZvcm1WYWx1ZSB7XG4gIG5hbWU6IHN0cmluZztcbiAgZW1haWw6IHN0cmluZztcbn1cblxuY29uc3QgdXBkYXRlRm9ybVN0YXRlID0gdXBkYXRlR3JvdXA8Rm9ybVZhbHVlPihcbiAge1xuICAgIG5hbWU6IHZhbGlkYXRlKHJlcXVpcmVkKSxcbiAgfSxcbiAge1xuICAgIGVtYWlsOiAoZW1haWwsIHBhcmVudEdyb3VwKSA9PlxuICAgICAgcGFyZW50R3JvdXAuY29udHJvbHMubmFtZS5pc0ludmFsaWRcbiAgICAgICAgPyBzZXRWYWx1ZSgnJywgZW1haWwpXG4gICAgICAgIDogZW1haWwsXG4gIH0sXG4pO1xuXG5jb25zdCByZWR1Y2VyID0gY3JlYXRlRm9ybVN0YXRlUmVkdWNlcldpdGhVcGRhdGU8Rm9ybVZhbHVlPih1cGRhdGVGb3JtU3RhdGUpO1xuYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVGb3JtU3RhdGVSZWR1Y2VyV2l0aFVwZGF0ZTxUVmFsdWU+KFxuICB1cGRhdGVGbk9yVXBkYXRlRm5BcnI6IFByb2plY3RGbjxGb3JtU3RhdGU8VFZhbHVlPj4gfCBQcm9qZWN0Rm48Rm9ybVN0YXRlPFRWYWx1ZT4+W10sXG4gIC4uLnVwZGF0ZUZuQXJyOiBQcm9qZWN0Rm48Rm9ybVN0YXRlPFRWYWx1ZT4+W11cbik6IEFjdGlvblJlZHVjZXI8Rm9ybVN0YXRlPFRWYWx1ZT4+IHtcbiAgdXBkYXRlRm5BcnIgPSBbLi4uKEFycmF5LmlzQXJyYXkodXBkYXRlRm5PclVwZGF0ZUZuQXJyKSA/IHVwZGF0ZUZuT3JVcGRhdGVGbkFyciA6IFt1cGRhdGVGbk9yVXBkYXRlRm5BcnJdKSwgLi4udXBkYXRlRm5BcnJdO1xuICByZXR1cm4gKHN0YXRlOiBGb3JtU3RhdGU8VFZhbHVlPiB8IHVuZGVmaW5lZCwgYWN0aW9uOiBBY3Rpb24pOiBGb3JtU3RhdGU8VFZhbHVlPiA9PiB7XG4gICAgY29uc3QgbmV3U3RhdGUgPSBmb3JtU3RhdGVSZWR1Y2VyKHN0YXRlIGFzIEFic3RyYWN0Q29udHJvbFN0YXRlPFRWYWx1ZT4sIGFjdGlvbik7XG4gICAgcmV0dXJuIG5ld1N0YXRlID09PSBzdGF0ZSA/IHN0YXRlIDogdXBkYXRlRm5BcnIucmVkdWNlKChzLCBmKSA9PiBmKHMpLCBuZXdTdGF0ZSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIHJlZHVjZU5lc3RlZEZvcm1TdGF0ZTxUU3RhdGU+KHN0YXRlOiBUU3RhdGUsIGtleToga2V5b2YgVFN0YXRlLCBhY3Rpb246IEFjdGlvbik6IFRTdGF0ZSB7XG4gIGNvbnN0IHZhbHVlID0gc3RhdGVba2V5XTtcblxuICBpZiAoIWlzRm9ybVN0YXRlKHZhbHVlKSkge1xuICAgIHJldHVybiBzdGF0ZTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgLi4uc3RhdGUsXG4gICAgW2tleV06IGZvcm1TdGF0ZVJlZHVjZXIodmFsdWUsIGFjdGlvbiksXG4gIH07XG59XG5cbmZ1bmN0aW9uIHJlZHVjZU5lc3RlZEZvcm1TdGF0ZXM8VFN0YXRlPihzdGF0ZTogVFN0YXRlLCBhY3Rpb246IEFjdGlvbik6IFRTdGF0ZSB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhzdGF0ZSkucmVkdWNlKChzLCBrZXkpID0+IHJlZHVjZU5lc3RlZEZvcm1TdGF0ZShzLCBrZXkgYXMga2V5b2YgVFN0YXRlLCBhY3Rpb24pLCBzdGF0ZSk7XG59XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiByZXR1cm5zIGFuIG9iamVjdCB0aGF0IGNhbiBiZSBwYXNzZWQgdG8gbmdyeCdzIGBjcmVhdGVSZWR1Y2VyYFxuICogZnVuY3Rpb24gKGF2YWlsYWJsZSBzdGFydGluZyB3aXRoIG5ncnggdmVyc2lvbiA4KS4gQnkgZG9pbmcgdGhpcyBhbGwgZm9ybVxuICogc3RhdGUgcHJvcGVydGllcyBvbiB0aGUgc3RhdGUgd2lsbCBiZSB1cGRhdGVkIHdoZW5ldmVyIG5lY2Vzc2FyeSAoaS5lLlxuICogd2hlbmV2ZXIgYW4gbmdyeC1mb3JtcyBhY3Rpb24gaXMgZGlzcGF0Y2hlZCkuXG4gKlxuICogVG8gbWFudWFsbHkgdXBkYXRlIGEgZm9ybSBzdGF0ZSAoZS5nLiB0byB2YWxpZGF0ZSBpdCkgdXNlXG4gKiBgd3JhcFJlZHVjZXJXaXRoRm9ybVN0YXRlVXBkYXRlYC5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIG9uTmdyeEZvcm1zPFRTdGF0ZSA9IGFueT4oKTogeyByZWR1Y2VyOiBBY3Rpb25SZWR1Y2VyPFRTdGF0ZT47IHR5cGVzOiBzdHJpbmdbXSB9IHtcbiAgcmV0dXJuIHtcbiAgICByZWR1Y2VyOiAoc3RhdGUsIGFjdGlvbikgPT4gcmVkdWNlTmVzdGVkRm9ybVN0YXRlcyhzdGF0ZSEsIGFjdGlvbiksXG4gICAgdHlwZXM6IEFMTF9OR1JYX0ZPUk1TX0FDVElPTl9UWVBFUyxcbiAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBY3Rpb25Db25zdHJ1Y3RvciB7XG4gIG5ldyguLi5hcmdzOiBhbnlbXSk6IEFjdGlvbnM8YW55PjtcbiAgcmVhZG9ubHkgVFlQRTogc3RyaW5nO1xufVxuXG5leHBvcnQgdHlwZSBDcmVhdGVkQWN0aW9uPFRBY3Rpb25Db25zPiA9IFRBY3Rpb25Db25zIGV4dGVuZHMgbmV3ICguLi5hcmdzOiBhbnlbXSkgPT4gaW5mZXIgVEFjdGlvbiA/IFRBY3Rpb24gOiBuZXZlcjtcblxuLyoqXG4gKiBEZWZpbmUgYSByZWR1Y2VyIGZvciBhIG5ncngtZm9ybXMgYWN0aW9uLiBUaGlzIGZ1bmN0aW9ucyB3b3JrcyB0aGUgc2FtZSBhc1xuICogbmdyeCdzIGBvbmAgZXhjZXB0IHRoYXQgeW91IHByb3ZpZGUgdGhlIG5ncngtZm9ybXMgYWN0aW9uIGNsYXNzIGluc3RlYWQgb2ZcbiAqIHlvdXIgYWN0aW9uIGNyZWF0b3IgYXMgYSBwYXJhbWV0ZXIuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBvbk5ncnhGb3Jtc0FjdGlvbjxcbiAgVEFjdGlvbkNvbnMgZXh0ZW5kcyBBY3Rpb25Db25zdHJ1Y3RvcixcbiAgVFN0YXRlXG4+KFxuICBhY3Rpb25Db25zOiBUQWN0aW9uQ29ucyxcbiAgcmVkdWNlcjogKHN0YXRlOiBUU3RhdGUsIGFjdGlvbjogQ3JlYXRlZEFjdGlvbjxUQWN0aW9uQ29ucz4pID0+IFRTdGF0ZSxcbik6IHsgcmVkdWNlcjogQWN0aW9uUmVkdWNlcjxUU3RhdGU+OyB0eXBlczogc3RyaW5nW10gfSB7XG4gIHJldHVybiB7XG4gICAgcmVkdWNlcjogKHN0YXRlLCBhY3Rpb24pID0+IHJlZHVjZXIocmVkdWNlTmVzdGVkRm9ybVN0YXRlcyhzdGF0ZSEsIGFjdGlvbiksIGFjdGlvbiBhcyBhbnkpLFxuICAgIHR5cGVzOiBbYWN0aW9uQ29ucy5UWVBFXSxcbiAgfTtcbn1cblxuLyoqXG4gKiBUaGlzIGZ1bmN0aW9uIHdyYXBzIGEgcmVkdWNlciBhbmQgcmV0dXJucyBhbm90aGVyIHJlZHVjZXIgdGhhdCBmaXJzdCBjYWxsc1xuICogdGhlIGdpdmVuIHJlZHVjZXIgYW5kIHRoZW4gY2FsbHMgdGhlIGdpdmVuIHVwZGF0ZSBmdW5jdGlvbiBmb3IgdGhlIGZvcm0gc3RhdGVcbiAqIHRoYXQgaXMgc3BlY2lmaWVkIGJ5IHRoZSBmb3JtIHN0YXRlIGxvY2F0b3IgZnVuY3Rpb24uXG4gKlxuICogVGhlIHVwZGF0ZSBmdW5jdGlvbiBpcyBwYXNzZWQgdGhlIGZvcm0gc3RhdGUgYW5kIHRoZSB1cGRhdGVkIGNvbnRhaW5pbmcgc3RhdGVcbiAqIGFzIHBhcmFtZXRlcnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB3cmFwUmVkdWNlcldpdGhGb3JtU3RhdGVVcGRhdGU8VFN0YXRlLCBURm9ybVN0YXRlIGV4dGVuZHMgQWJzdHJhY3RDb250cm9sU3RhdGU8YW55Pj4oXG4gIHJlZHVjZXI6IEFjdGlvblJlZHVjZXI8VFN0YXRlPixcbiAgZm9ybVN0YXRlTG9jYXRvcjogKHN0YXRlOiBUU3RhdGUpID0+IFRGb3JtU3RhdGUsXG4gIHVwZGF0ZUZuOiAoZm9ybVN0YXRlOiBURm9ybVN0YXRlLCBzdGF0ZTogVFN0YXRlKSA9PiBURm9ybVN0YXRlLFxuKTogQWN0aW9uUmVkdWNlcjxUU3RhdGU+IHtcbiAgcmV0dXJuIChzdGF0ZSwgYWN0aW9uKSA9PiB7XG4gICAgY29uc3QgdXBkYXRlZFN0YXRlID0gcmVkdWNlcihzdGF0ZSwgYWN0aW9uKTtcblxuICAgIGNvbnN0IGZvcm1TdGF0ZSA9IGZvcm1TdGF0ZUxvY2F0b3IodXBkYXRlZFN0YXRlKTtcbiAgICBjb25zdCBmb3JtU3RhdGVLZXkgPSBPYmplY3Qua2V5cyh1cGRhdGVkU3RhdGUpLmZpbmQoa2V5ID0+IHVwZGF0ZWRTdGF0ZVtrZXkgYXMga2V5b2YgVFN0YXRlXSBhcyBhbnkgPT09IGZvcm1TdGF0ZSkhO1xuXG4gICAgY29uc3QgdXBkYXRlZEZvcm1TdGF0ZSA9IHVwZGF0ZUZuKGZvcm1TdGF0ZSwgdXBkYXRlZFN0YXRlKTtcblxuICAgIGlmICh1cGRhdGVkRm9ybVN0YXRlID09PSBmb3JtU3RhdGUpIHtcbiAgICAgIHJldHVybiB1cGRhdGVkU3RhdGU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnVwZGF0ZWRTdGF0ZSxcbiAgICAgIFtmb3JtU3RhdGVLZXldOiB1cGRhdGVkRm9ybVN0YXRlLFxuICAgIH07XG4gIH07XG59XG4iXX0=